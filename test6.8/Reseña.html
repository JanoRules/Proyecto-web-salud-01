<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Salud - Reseña</title>
    <link rel="stylesheet" href="Reseña.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="logo100.png" alt="Ministerio de Salud" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="Ultimas-novedades.html">Últimas Novedades</a></li>
                    <li class="nav-item"><a class="nav-link" href="Reseña.html">Reseña</a></li>
		    <li class="nav-item"><a class="nav-link" href="Reseña2.html">Reseña</a></li>
                    <li class="nav-item"><a class="nav-link" href="contacto.html">Contáctanos</a></li>
                    <li class="nav-item"><a class="nav-link" href="FAQ.html">Preguntas Frecuentes</a></li>
                    <li class="nav-item"><a class="nav-link" href="AgendarHora.html">Agenda tu hora</a></li>
                </ul>
                <div class="d-flex"><a class="btn btn-outline-light" href="login2.html">Iniciar Sesión</a></div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-5">
        <h2 class="text-center">Agregar una Reseña</h2>
        <form id="review-form" action="guardar_reseña.php" method="POST">
            <div class="mb-3">
                <label for="name" class="form-label">Nombre:</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>

            <div class="mb-3">
                <label for="centro-salud" class="form-label">Seleccione Centro de Salud:</label>
                <select class="form-select" id="centro-salud" name="centro_salud" required>
                    <option value="" disabled selected>Seleccione centro de salud</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="rating" class="form-label">Calificación:</label>
                <div class="rating">
                    <input type="radio" id="star1" name="rating" value="1" required>
                    <label for="star1">⭐</label>
                    <input type="radio" id="star2" name="rating" value="2" required>
                    <label for="star2">⭐</label>
                    <input type="radio" id="star3" name="rating" value="3" required>
                    <label for="star3">⭐</label>
                    <input type="radio" id="star4" name="rating" value="4" required>
                    <label for="star4">⭐</label>
                    <input type="radio" id="star5" name="rating" value="5" required>
                    <label for="star5">⭐</label>
                </div>
                <small class="form-text text-muted">Selecciona una calificación de 1 a 5.</small>
                <div id="selected-rating" class="text-center mt-2"></div>
            </div>

            <div class="mb-3">
                <label for="review" class="form-label">Reseña:</label>
                <textarea class="form-control" id="review" name="review" required rows="4"></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Enviar Reseña</button>
	        <a href="ver_reseñas.html?centro_salud_id=1" class="btn btn-secondary">Ver Reseñas de Usuarios</a>
        </form>

        <div id="message" class="mt-3"></div> <!-- Para mostrar mensajes -->
<div id="favoritos" class="mt-5">
    <h3>Centros de Salud Favoritos</h3>
    <ul id="lista-favoritos"></ul>
</div>


        <h2 class="mt-5">Centros de Salud Cercanos</h2>
        <div id="lista-centros" class="mt-3"></div> <!-- Aquí se agregarán los centros de salud -->

        <section id="reviews-list" class="mt-5">
            <h2>Reseñas de Usuarios en tu Comuna</h2>
            <div id="contenedor-reseñas"></div> <!-- Aquí se agregarán las reseñas geolocalizadas -->
        </section>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=TU_API_KEY&callback=initMap" async defer></script>
    <script>
        let map;

        function mostrarMapa(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            const userLocation = { lat: lat, lng: lng };

            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 12,
            });

            // Mostrar la ubicación del usuario
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Tu ubicación",
            });

            // Llamar a tu backend para obtener los centros de salud cercanos
            fetchCentrosSaludCercanos(lat, lng);
        }

        function fetchCentrosSaludCercanos(lat, lng) {
            fetch(`obtener_centros_salud.php?lat=${lat}&lng=${lng}`)
                .then(response => response.json())
                .then(data => {
                    data.centros.forEach(centro => {
                        const marker = new google.maps.Marker({
                            position: { lat: parseFloat(centro.lat), lng: parseFloat(centro.lng) },
                            map: map,
                            title: centro.nombre,
                        });

                        const infoWindow = new google.maps.InfoWindow({
                            content: `<h3>${centro.nombre}</h3>
                                      <button onclick="marcarFavorito(${centro.id})">Marcar como favorito</button>
                                      <a href="ver_resena.php?centro_id=${centro.id}">Ver Reseñas</a>`,
                        });

                        marker.addListener('click', () => {
                            infoWindow.open(map, marker);
                        });
                    });
                })
                .catch(error => console.error('Error:', error));
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(mostrarMapa, function(error) {
                    console.error('Error de geolocalización:', error);
                    alert('No se pudo obtener tu ubicación.');
                });
            } else {
                alert('La geolocalización no está soportada por este navegador.');
            }
            initMap();
        });
        document.addEventListener('DOMContentLoaded', function() {
            // Geolocalización: Obtener la posición del usuario
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Enviar latitud y longitud al servidor para obtener centros cercanos
                    fetch(`obtener_centros.php?lat=${lat}&lon=${lon}`)
                    .then(response => response.json())
                    .then(data => {
                        mostrarCentros(data);
                        cargarCentrosSalud(data); // Cargar centros en el desplegable
                    })
                    .catch(error => console.error('Error al obtener los centros:', error));
                }, function(error) {
                    console.error('Error de geolocalización:', error);
                    alert('No se pudo obtener tu ubicación.');
                });
            } else {
                alert('La geolocalización no está soportada por este navegador.');
            }
obtenerFavoritos();
});

function obtenerFavoritos() {
    fetch('obtener_favoritos.php')
    .then(response => response.json())
    .then(data => {
        const listaFavoritos = document.getElementById('lista-favoritos');
        listaFavoritos.innerHTML = ''; // Limpiar la lista antes de agregar los favoritos

        data.favoritos.forEach(favorito => {
            const li = document.createElement('li');
            li.textContent = favorito.nombre;
            listaFavoritos.appendChild(li);
        });
    })
    .catch(error => console.error('Error:', error));
}
function initMap() {
    // Verifica si el navegador soporta geolocalización
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            const userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };

            // Crea el mapa centrado en la ubicación del usuario
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 12,
                center: userLocation
            });

            // Agrega un marcador en la ubicación del usuario
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "Tu ubicación"
            });

            // Llama a la función para cargar los centros de salud cercanos
            cargarCentrosSalud(userLocation, map);
        }, () => {
            alert('Error al obtener tu ubicación.');
        });
    } else {
        alert('La geolocalización no está soportada por este navegador.');
    }
}
function mostrarNotificacion(mensaje) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('alert', 'alert-info');
    messageDiv.innerText = mensaje;

    // Estilo de la notificación
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '10px';
    messageDiv.style.left = '50%';
    messageDiv.style.transform = 'translateX(-50%)';
    messageDiv.style.zIndex = '9999';
    messageDiv.style.padding = '10px';
    messageDiv.style.borderRadius = '5px';

    // Mostrar el mensaje
    document.body.appendChild(messageDiv);

    // Ocultar el mensaje después de 3 segundos
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

        // Función para mostrar los centros en el HTML
        function mostrarCentros(centros) {
            const listaCentros = document.getElementById('lista-centros');
            listaCentros.innerHTML = ''; // Limpiar centros previos

            centros.forEach(centro => {
                const centroDiv = document.createElement('div');
                centroDiv.className = 'centro card mb-3';
                centroDiv.innerHTML = 
                    `<div class="card-body">
                        <h5 class="card-title">${centro.nombre}</h5>
                        <p class="card-text">Atención: ${centro.atencion}</p>
                        <p class="card-text">Tipo: ${centro.tipo}</p>
                        <p class="card-text">Horario: ${centro.horario}</p>
                        <p class="card-text">Servicios: ${centro.servicios}</p>
                        <p class="card-text">Rating: ${centro.rating}</p>
                        <button class="btn btn-warning" onclick="marcarFavorito(${centro.id})">Agregar a Favoritos</button>
                    </div>`;
                listaCentros.appendChild(centroDiv);
            });
        }

        // Función para cargar centros de salud en el desplegable
        function cargarCentrosSalud(centros) {
            const centroSaludSelect = document.getElementById('centro-salud');

            centros.forEach(centro => {
                const option = document.createElement('option');
                option.value = centro.id; // Suponiendo que cada centro tiene un id único
                option.textContent = centro.nombre; // Nombre del centro
                centroSaludSelect.appendChild(option);
            });
            // Agregar un listener para mostrar notificación al seleccionar un centro
    centroSaludSelect.addEventListener('change', function() {
        const centroSeleccionado = centroSaludSelect.options[centroSaludSelect.selectedIndex];
        const centroNombre = centroSeleccionado.text;
        
        // Mostrar notificación
        mostrarNotificacion(`Has seleccionado el centro de salud: ${centroNombre}`);
    });
        }

        function marcarFavorito(centroId) {
    fetch(`marcar_favorito.php?centro_id=${centroId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar notificación
                mostrarNotificacion(`El centro de salud ha sido marcado como favorito.`);
            } else {
                mostrarNotificacion(`Hubo un error al marcar el centro como favorito.`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al realizar la acción.');
        });
}

function obtenerFavoritos() {
    fetch('obtener_favoritos.php')
    .then(response => response.json())
    .then(data => {
        const listaFavoritos = document.getElementById('lista-favoritos');
        listaFavoritos.innerHTML = ''; // Limpiar la lista antes de agregar los favoritos

        data.favoritos.forEach(favorito => {
            const li = document.createElement('li');
            li.textContent = favorito.nombre;
            listaFavoritos.appendChild(li);
        });
    })
    .catch(error => console.error('Error:', error));
}

    </script>
</body>
</html>

